#include <Arduino.h>
#include <math.h>
#include <util/atomic.h>
#include <AccelStepper.h>
//#include "encoders.h"
#include "pinOutIn.h"
#include "serial.h"



#define DT_TIME_SEND_MOTOR_DATA 1000
#define DT_BLUETOOTH_DATA 3
#define DT_CALC_SPEED 5000
#define MAX_ACCELERATION 1000
#define MAX_SPEED 1000

AccelStepper stepper2(AccelStepper::DRIVER, STEP_2, DIR_2);
AccelStepper stepper3(AccelStepper::DRIVER, PB6, PB5);
AccelStepper stepper1(AccelStepper::DRIVER, STEP_1, DIR_1);

int inc = 40;
int v=10;
int direction = 1;
int res=0;

int nextCalcSpeed  = (millis() + DT_CALC_SPEED);

void setup() {
  //Declare pins as output:
  pinMode(PB7, OUTPUT); //sleep
  pinMode(PB8, OUTPUT); //reset
  pinMode(PB6, OUTPUT); //step
  pinMode(PB5, OUTPUT); //dir

  stepperDriver2();
  stepperDriver1();
  
  setUpSerialMonitor();

  // pinMode(DIR_2, OUTPUT); //sleep
  // pinMode(STEP_2, OUTPUT); //reset
  // pinMode(SLEEP_2, OUTPUT); //step
  // pinMode(RESET_2, OUTPUT); //dir

  // pinMode(DIR_1, OUTPUT); //sleep
  // pinMode(STEP_1, OUTPUT); //reset
  // pinMode(SLEEP_1, OUTPUT); //step
  // pinMode(RESET_1, OUTPUT); //dir

  
  stepper2.setMaxSpeed(MAX_SPEED);
  stepper2.setAcceleration(MAX_ACCELERATION);
  //stepper2.setSpeed(400);

  // stepper3.setMaxSpeed(MAX_SPEED);
  // stepper3.setAcceleration(MAX_ACCELERATION);
  // stepper3.setSpeed(400);

  stepper1.setMaxSpeed(MAX_SPEED);
  stepper1.setAcceleration(MAX_ACCELERATION);

}

void loop() {
  //Set the spinning direction clockwise:
  // digitalWrite(PB7, HIGH);
  // digitalWrite(PB8, HIGH);

  digitalWrite(SLEEP_2, HIGH);
  digitalWrite(RESET_2, HIGH);

  digitalWrite(SLEEP_1, HIGH);
  digitalWrite(RESET_1, HIGH);

  stepper1.setSpeed(-400);
  stepper1.runSpeed();



  //delay(5000);


  if (millis()>=nextCalcSpeed){

    if (direction==0){
        inc++;
    }
    if (direction==1){
        inc--;
    }
    if (inc>=60){
        direction=1;    
    }
    if (inc<=40){
        direction=0;
    }

    res = v*inc;
    Serial.println(res);

    stepper2.setSpeed(res);
    nextCalcSpeed = millis() + DT_CALC_SPEED;
  }



  //stepper3.setSpeed(400);
  //stepper3.runSpeed();


  
  stepper2.runSpeed();

}